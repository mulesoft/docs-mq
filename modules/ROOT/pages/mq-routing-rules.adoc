= Configure Rules on Message Exchanges to Route Messages

Anypoint MQ includes the ability to create _intelligent message routing rules_ to route a subset of the messages published to an exchange to a specific queue.

You configure the message routing rule on the binding on an exchange.
When you publish a message to the exchange, the message routing rule
routes the message to a queue only if the message includes
a property or header that matches the rule.

[NOTE]
include::partial$mq-msg-exchange.adoc[tag=exchBindingNoRules]

image::mq-route-message.png["Routing rules on exchange bindings"]

For example, you might want to designate a queue to handle all orders for size medium items and another queue for premium items.


To route messages published to an exchange to specific queues:

. Define message routing rules on the binding between the exchange and the queue.
+
You configure one message routing rule per binding on the exchange.
include::partial$mq-msg-exchange.adoc[tag=msgRulesEval]
. Specify filtering criteria by defining `properties` and `headers` in the message.
+
If you publish the following message to the `purchases` exchange,
the exchange forwards it only to `premiumPurchases` queue and 
not to the `sizeMedium` queue based on the routing rule configuration.
+
[source,json,linenums]
----
{
    "headers" : {
        "itemSize" : "large"
    },
    "body" : "User added an item to the cart"
}
----

== Create or Change a Message Routing Rule 

To create or change message routing rules, use the Anypoint MQ Admin API.

For information, see
xref:mq-apis.adoc#routing-rules-api[Create Message Routing Rules].

== Publish a Message with Routing Properties

To publish messages to an exchange and route them to specific queues, 
use either:

Anypoint MQ *Message Sender* page::
When sending the message:
+
--
.. Toggle *Add User Properties*.
.. Specify the filter criteria as property name-value pairs to send.
--
+
For information, see 
xref:mq-queues.adoc#send-message-to-queue[Send a Message to a Queue].
Anypoint MQ Broker API::
+
For information, see 
xref:mq-apis.adoc#publish-message-routing[Publish a Message with Routing Properties].

[[intelligent-routing-restrictions]]
== Requirements and Restrictions

Anypoint MQ supports message routing rules with the following restrictions:

* Exchanges must have 10 or fewer queue bindings.
+
If an exchange has more than 10 queue bindings, you cannot configure message routing rules.
* You can configure a message routing rule on only one property with the following restrictions:
+
** Maximum size of the property name is 180 bytes.
** Maximum size of the property value is 45 KB.

Anypoint MQ evaluates messages against the routing rule only if they meet the following criteria:

* Total number of headers and properties is fewer than 500.
+
This total includes operational headers, such as `messageId` and `createdTimestamp`, that Anypoint MQ creates.
* Maximum total size of headers and properties is 215 KB.

If a message doesn't meet these criteria, Anypoint MQ ignores the properties
when evaluating the message against the message routing rules.
Anypoint MQ publishes the message, including the headers and properties, to the exchange without filtering.

== See Also

* xref:mq-apis.adoc#routing-rules-api[Create Message Routing Rules]
* xref:mq-apis.adoc#publish-message-routing[Publish a Message with Routing Properties]