= Routing Messages to Queues Bound to an Exchange

Anypoint MQ includes the ability to create _intelligent message routing rules_ to control where to route messages published to an exchange.

When you publish messages to an exchange, the message routing rules
route messages to specific queues only if the message includes
a property or header that matches the rule.

For example, you might want to designate a queue to handle all orders for size medium items and another queue for premium items.

To route messages published to an exchange to specific queues:

. Define message routing rules on the binding between the exchange and the queue.
+
image::mq-route-message.png["Routing rules on exchange bindings"]
. Specify filtering criteria by defining properties in the message.
+
If the following message is published to the `purchases` exchange,
the exchange forwards it only to `premiumPurchases` queue and 
not to the `sizeMedium` queue based on the routing rule configuration.
+
[source,json,linenums]
----
{
    "headers" : {
        "ttl" : 5,
        "itemCategory" : "premium",
        "itemSize" : "large"
    },
    "body" : "User added an item to the cart"
}
----

== Create or Change Routing Rules 

To create or change message routing rules, use the Anypoint MQ Admin API.

For information, see
xref:mq-apis.adoc#routing-rules-api[Create Routing Rules Using the Admin API].

== Route Messages to a Queue that is Bound to an Exchange

To publish messages to an exchange and route them to specific queues, 
use either:

Anypoint MQ *Message Sender* page::
When sending the message:
+
--
.. Toggle *Add User Properties*.
.. Specify the filter criteria as property name-value pairs to send.
--
+
For information, see 
xref:mq-queues.adoc#send-message-to-queue[Send a Message to a Queue].
Anypoint MQ Broker API::
+
For information, see 
xref:mq-apis.adoc#publish-message-routing[Publish a Message with Routing Properties].

[[intelligent-routing-limitations]]
== Limitations

Anypoint MQ supports message routing rules with the following limitations:

* Exchanges must have 10 or fewer queue bindings.
+
If an exchange has more than 10 queue bindings, you cannot use intelligent message routing.
* Each message routing rule can include one property-value pair.
* Maximum size of the property name is 180 bytes.
* Maximum size of the property value is 45 KB.

Anypoint MQ supports message filtering for messages that meet the following criteria:

* Maximum size of headers and property names is 180 bytes.
* Total number of headers and properties is fewer than 500.
+
This total includes operational headers, such as `messageId` and `createdTimestamp`, that Anypoint MQ creates.

If a message doesn't meet these criteria, Anypoint MQ publishes the message to
the exchange but ignores the properties when evaluating the message against the routing rules configured on the bindings.
