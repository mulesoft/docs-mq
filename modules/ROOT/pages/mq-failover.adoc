= Configuring Cross-Region Failover for Standard Queues

Anypoint Connector for Anypoint MQ (Anypoint MQ Connector) for Mule 4 provides failover capability for standard queues.

When you enable failover for a queue, Anypoint MQ automatically creates a fallback queue in a <<primary-fallback-regions,fallback region>>.
If a Mule app can't reach an Anypoint MQ server in a region,
it switches to the fallback queue to publish and consume messages.
For information about situations that can cause a region to be considered unavailable, see <<region-unavailability>>.

IMPORTANT: This feature provides _resiliency_ by switching to a fallback queue in a fallback region when the primary region is down.
It doesn't provide _data redundancy_ by replicating messages across the primary and fallback queues. 

When it detects that the primary region is down, the connector:

* Switches to the fallback queue to publish and consume new messages.
* Periodically checks if the primary region is back up.
+
When the connector successfully detects that it can communicate with the primary region,
it switches processing back to the primary queue.
The consumer continues to read from the fallback queue until all messages in that queue are processed.

Fallback queues are managed by the Anypoint MQ server and are not configurable by end users.
The fallback queue inherits the settings of the primary queue, such as message TTL and default acknowledgment timeout.
The fallback regions are also not configurable.

You can disable failover, but you can't delete the fallback queue.
When you disable failover for a queue, apps can still consume any messages that remain in the queue but can't publish new messages to the queue.


[[failover-considerations]]
== Failover Limitations and Considerations

* Failover Support
+
** Failover is supported for standard queues only.
** Failover isn't supported for message exchanges or FIFO queues.
* Fallback Regions
+
--
** Because MuleSoft Government Cloud includes only one region, it does not support failover.
** The fallback queue for Canada is located in the US East (N. Virginia) region because Anypoint MQ is available in only one region in Canada.
** The fallback queue for Australia is located in the Asia Pacific (Singapore) region because Anypoint MQ is available in only one region in Australia.
--
+
For the list of fallback regions, see <<primary-fallback-regions>>.
* Authentication
+
If access management is unavailable when the connector switches to the fallback region,
the connector might not be able to successfully switch to the fallback region if it can't validate the access token.
* Anypoint MQ UI
+
The *Message Sender* and *Message Browser* in the Anypoint MQ UI don't support the failover feature.
When you xref:mq-queues.adoc#send-message-to-queue[send a message] using the *Message Browser*, the message is published to the specified queue.
However, if the primary region is down, the message is not forwarded to the fallback queue.
* Performance and Billing
+
The Consumer and Subscriber operations in Anypoint MQ Connector periodically check the fallback queue for new messages.
Each request counts against your monthly 
xref:mq-usage.adoc#api-requests[API request] quota.
These checks can also can cause latency.
+
You can configure how frequently the connector checks the fallback queue. See <<configure-check-frequency>>.

[[before-you-begin]]
== Before You Begin

To use failover, you must upgrade Anypoint MQ Connector to one of the following versions:

* xref:anypoint-mq-connector::index.adoc[Anypoint MQ Connector 4.0.4] or later
* xref:connectors::anypoint-mq/3.x/anypoint-mq-connector.adoc[Anypoint MQ Connector 3.2.5] or later

[[enable-failover]]
== Enable Failover for a New or Existing Queue

Enabling cross-region failover creates a fallback queue in a <<primary-fallback-regions,fallback region>>.

NOTE: If either primary or fallback region is unavailable, enabling failover via the Anypoint MQ UI or REST API might not work.

// Configure DLQ before enabling failover
include::partial$mq-failover.adoc[tag=fallbackDLQ]

To enable failover for a new or existing queue:

. Sign in to Anypoint Platform and click *MQ* in the navigation menu.
. Click *Destinations*.
. Create a queue or modify an existing queue:
+
[tabs]
====
Create a queue::
+
.. Click the *Add* icon to display the menu:
+
image::mq-blue-create.png["Add icon"]
.. Select *Queue*.
+
Anypoint MQ supports failover for standard queues only.
.. Complete the fields in *Create Queue*.
+
For information about queue settings, see xref:mq-queues.adoc#create-a-queue[Create a Queue].
+
.. Select *Enable Cross-Region Failover*:
+
image::mq-create-queues-failover.png["Create Queue popup dialog box with failover option selected"]
// added screenshot
.. Click *Create Queue*.
+ 
Anypoint MQ creates the queue and also creates a fallback queue in the fallback region.
// Fallback queue naming
include::partial$mq-failover.adoc[tag=fallbackQname]
+
// Fallback queue/region not configurable
include::partial$mq-failover.adoc[tag=fallbackQnotConfig]
Modify an existing queue::
+
--
.. Click the queue name.
+
Anypoint MQ supports failover for standard queues only.
+
.. In the *Queue Settings* page, select *Enable Cross-Region Failover*:
+
image::mq-queue-settings-failover.png["Queue Settings page with failover option selected"]
// added screenshot

.. Click *Save Changes*.
+
Anypoint MQ updates the queue settings and creates a fallback queue in the fallback region.
// Fallback queue naming
include::partial$mq-failover.adoc[tag=fallbackQname]
+
// Fallback queue/region not configurable
include::partial$mq-failover.adoc[tag=fallbackQnotConfig]
+
If you previously enabled failover for the queue, the fallback queue already exists and is reinstated.
.. Restart all applications consuming from or publishing to the queue.
--
====

=== View Fallback Queue Details

To view failover configuration for the primary and fallback queues, display the queue details:

. Sign in to Anypoint Platform and click *MQ* in the navigation menu.
. Click *Destinations*.
. Click the queue type to display its details, including the failover configuration.
+
** The queue details pane for the primary queue includes the fallback queue:
+
image::mq-queue-details-failover.png["Details pane for the primary queue with the fallback queue and region"]
+
[calloutlist]
... Queue type displays the queue details pane for the primary queue.
... The name of the fallback queue is the primary queue name with the `_fb` suffix.

** The queue details pane for the fallback queue includes the primary queue:
+
image::mq-queue-fallback-details.png["Details pane for the fallback queue with the primary queue and region"]
+
[calloutlist]
... Queue type displays the queue details pane for the fallback queue.
... The name of the primary queue is the fallback queue name without the `_fb` suffix.


[[disable-failover]]
== Disable Failover for a Queue

When you disable failover for a queue, apps can still consume any messages that remain in the queue but can't publish new messages to the queue.
When you re-enable failover, Anypoint MQ reinstates the same fallback queue.

IMPORTANT: When you disable failover for a queue, you must restart all applications that consume from or publish to the queue.

To disable failover for a queue:

. Sign in to Anypoint Platform and click *MQ* in the navigation menu.
. Click *Destinations*.
. Click the queue name.
. In the *Queue Settings* page, deselect *Enable Cross-Region Failover*.
. Click *Save Changes*.
+
Anypoint MQ disables failover and removes the fallback queue from the queue details pane.
. Restart all applications consuming from or publishing to the queue.


[[primary-fallback-regions]]
== Primary-Fallback Regions

[%header,cols="8,12,12,12,12"]
|===
| Location | Primary Region Name | Primary Region |Fallback Region Name|Fallback Region
5+h| US Control Plane
.4+| North America | US East (N. Virginia)|`us-east-1` | US East (Ohio)|`us-east-2`
                   | US East (Ohio)       |`us-east-2` | US West (Oregon)|`us-west-2`
                   | US West (Oregon)<<region-note,**>>     |`us-west-2`| Canada  (Central)|`ca-central-1`
                   | Canada  (Central)<<region-note-unavailable,*>>    |`ca-central-1`| US East (N. Virginia)|`us-east-1`
.2+| Europe        | Europe (Ireland)<<region-note,**>>     |`eu-west-1`| Europe (London)|`eu-west-2`
                   | Europe (London)<<region-note,**>>      |`eu-west-2`| Europe (Ireland)|`eu-west-1` 
.3+| APAC          | Asia Pacific (Singapore)<<region-note,**>> |`ap-southeast-1`| Asia Pacific (Tokyo)|`ap-northeast-1`
                   | Asia Pacific (Sydney)<<region-note-unavailable,*>> |`ap-southeast-2`| Asia Pacific (Singapore)|`ap-southeast-1`
                   | Asia Pacific (Tokyo)<<region-note,**>>  |`ap-northeast-1`| Asia Pacific (Sydney)|`ap-southeast-2`
5+h| EU Control Plane
.2+| Europe        | Europe (Frankfurt)<<region-note,**>>    |`eu-central-1`| Europe (Ireland)|`eu-west-1`
                   | Europe (Ireland)<<region-note,**>>      |`eu-west-1`| Europe (Frankfurt)|`eu-central-1` 
|===

[[region-note-unavailable]]
^***^ {empty}
Because Anypoint MQ is available in only one region in this country, 
the fallback region is not in the same country as the primary region.

[[region-note]]
^****^ {empty}
The fallback region for this region is not in the same country as the primary region.

[[region-unavailability]]
== Region Unavailability

The connector considers a region as unavailable in cases where the Anypoint MQ backend server is:

* Down, resulting in HTTP 5xx (Server Error) status codes to the connector.
* Up, but is slow or unresponsive.
+
For example, the connector receives Timeout errors while making REST API calls to the backend server.
* Available in some situations, but not others.
+
For example:
+
** Unresponsive for queues, but available for other usage, such as message exchanges
** Unavailable for publishing large payloads but available for publishing smaller messages

When the connector receives an HTTP 5xx or any server-side error,
it temporarily marks the region as down for the specific queue and switches to the fallback queue.

The connector periodically checks if the primary region is back up.

[[configure-check-frequency]]
== Configure Frequency of Fallback Queue Checks


To change how frequently the connector checks for new messages in the fallback queue, set application properties in Runtime Manager:

. Sign in to Anypoint Platform and click *Runtime Manager* in the navigation menu.
. Deploy a new app or change the settings for a deployed app.
. On the *Properties* tab, specify values for the following properties (in seconds):
+
image::mq-set-properties-failover.png["Properties tab with failover properties specified"]
+
--
** `primary.region.status.check.interval.ms`
+
Specifies how often to check that the primary region is up when processing from the fallback region.
** `fallback.messages.status.check.interval.ms`
+
Specifies how often to check the fallback queue for any messages received.
--

[[check-interval]]
=== Considerations for Check Intervals

To determine how to configure the application property values: 

* When publishing to the fallback region, you might experience latencies because every publish check if the primary region is up.
+
To reduce publish latency, set `fallback.messages.check.interval.ms` to be greater than the publisher trigger frequency. (what is this?)

* After switching back to the primary queue, the consumer checks the fallback queue for messages before checking the primary queue.
Even if the fallback queue has no messages, this check can result in latency.
+
To reduce consume or subscribe latency, set `fallback.messages.status.check.interval.ms` to be greater than the consume/subscribe trigger frequency. (what is this?)

* After switching back to the primary queue, if the fallback region is down, consuming experiences latencies because the consumer continues to check the fallback queue. 
This check can add a maximum of 60 seconds to time out.
+
To reduce consume latency when the primary queue is up but the fallback region is down, set `fallback.messages.status.check.interval.ms` to a larger value to reduce the frequency of checking the fallback queue.
+
NOTE: A large value might result in out-of-order messages because messages in fallback queue are not processed as frequently.


== See Also

* xref:cloudhub::cloudhub-manage-props.adoc[] (CloudHub)
* xref:cloudhub-2::ch2-manage-props.adoc[] (CloudHub 2.0)
* xref:anypoint-mq-connector::anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 4.x Reference]
* xref:connectors::anypoint-mq/3.x/anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 3.x Reference]
* xref:mq-queues.adoc[]
* xref:mq-queues.adoc#create-a-queue[Create a Queue]
