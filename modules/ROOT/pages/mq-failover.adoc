= Configuring Cross-Region Failover for Standard Queues

Anypoint Connector for Anypoint MQ (Anypoint MQ Connector) for Mule 4 provides failover capability for standard queues.

// work on this wording
IMPORTANT: Anypoint MQ failover provides _failover_ using a fallback queue for publishing and consuming;
it doesn't provide _redundancy_ by replicating messages across regions. 

When you enable failover for a queue, Anpoint MQ automatically creates a fallback queue in a <<primary-fallback-regions,fallback region>>.
If a Mule app can't reach an Anypoint MQ server in a region,
it switches to the fallback queue to publish and consume messages.
For information about situations that can cause a region to be considered unavailable, see <<region-unavailability>>.

When it detects that the primary region is down, the connector:

* Switches to the fallback queue to consume new messages.
* Periodically tries to publish or consume from the primary queue to determine if it is back up.
+
When the connector successfully publishes or consumes from the primary queue,
the primary region is considered available and the consumer switches processing back to the primary queue.

The fallback queue inherits the settings of the primary queue, such as message TTL and default acknowledgment timeout, and is not configurable.
The fallback regions are also not configurable.
You can disable failover, but you cannot delete the fallback queue.

[[failover-considerations]]
== Failover Limitations and Considerations

* Failover Support
+
** Failover is supported for standard queues only.
** Failover isn't supported for message exchanges or FIFO queues.
* Fallback Regions
+
--
** Because MuleSoft Government Cloud includes only one region, it does not support failover.
** The fallback queue for Canada is located in the US East (N. Virginia) region because Canada includes only one region.
** The fallback queue for Australia is located in the Asia Pacific (Singapore) region because Australia includes only one region.
--
+
For the list of fallback regions, see <<primary-fallback-regions>>.
* Authentication
+
If the authentication server is down when the connector switches to the fallback region:
+
** If the access tokens are cached, processing continues in the fallback region.
** If the access tokens aren't cached, Anypoint MQ can't validate access tokens and processing won't continue in the fallback region. 
* Anypoint MQ UI
+
The *Message Sender* and *Message Browser* in the Anypoint MQ UI don't support the failover feature.
However, if the failover feature is enabled, you can send and browse messages in the fallback queue using the Anypoint MQ UI.
* Billing
+
** The consumer checks the fallback queue once per minute by default, which results in an additional 1440 API requests per day per consumer.
+
You can configure how frequently the consumer checks the fallback queue. See <<perf-and-billing>>.


[[before-you-begin]]
== Before You Begin

* To use failover, you must upgrade Anypoint MQ Connector to one of the following versions:
+
** xref:anypoint-mq-connector::index.adoc[Anypoint MQ Connector 4.0.4] or later
** xref:connectors::anypoint-mq/3.x/anypoint-mq-connector.adoc[Anypoint MQ Connector 3.2.5] or later
// Configure DLQ before enabling failover
* {empty}
include::partial$mq-failover.adoc[tag=fallbackDLQ]

[[enable-failover]]
== Enable Failover for a New or Existing Queue

Enabling cross-region failover creates a fallback queue in a <<primary-fallback-regions,fallback region>>.

NOTE: If either primary or fallback region is unavailable, enabling failover might not work.

To enable failover for a new or existing queue:

. Sign in to Anypoint Platform and click *MQ* in the navigation menu.
. Click *Destinations*.
. Create or modify an existing queue:
+
.Create a queue.
[%collapsible]
====
.. Click the *Add* icon to display the menu:
+
image::mq-blue-create.png["Add icon"]
.. Select *Queue*.
+
Anypoint MQ supports failover for standard queues only.
.. Complete the fields in *Create Queue*.
+
For information about queue settings, see xref:mq-queues.adoc#create-a-queue[Create a Queue].
+
.. Select *Enable Cross-Region Failover*:
+
image::mq-create-queues-failover.png["Create Queue popup dialog box with failover option selected"]
// replace screenshot
.. Click *Create Queue*.
+ 
Anypoint MQ creates the queue and also creates a fallback queue in the fallback region.
+
// Fallback queue/region not configurable
include::partial$mq-failover.adoc[tag=fallbackQnotConfig]
====
+
.Modify an existing queue.
[%collapsible]
====
.. Click the queue name.
+
Anypoint MQ supports failover for standard queues only.
+
.. In the *Queue Settings* page, select *Enable Cross-Region Failover*:
+
image::mq-create-queues-failover.png["Create Queue popup dialog box with failover option selected"]
// replace screenshot

.. Click *Save Changes*.
+
Anypoint MQ updates the queue settings and creates a fallback queue in the fallback region.
+
// Fallback queue/region not configurable
include::partial$mq-failover.adoc[tag=fallbackQnotConfig]
+
If you previously enabled failover for the queue, the fallback queue already exists and is reinstated.
.. Click *Destinations*.
.. Click the queue type to display its details, including the fallback queue.
.. Restart all applications consuming from or publishing to the queue.
====
+
// Fallback queue naming
include::partial$mq-failover.adoc[tag=fallbackQname]
+
The queue details pane includes the fallback queue:
+
image::mq-queue-details-fallback.png["Details pane for the new queue with the fallback queue and region"]


[[disable-failover]]
== Disable Failover for a Queue

When you disable failover for a queue, apps can still consume any messages that remain in the queue but can't publish new messages to the queue.
When you re-enable failover, Anypoint MQ reinstates the same fallback queue.

IMPORTANT: When you disable failover for a queue, you must restart all applications that consume from or publish to the queue.

To disable failover for a queue:

. Sign in to Anypoint Platform and click *MQ* in the navigation menu.
. Click *Destinations*.
. Click the queue name.
. In the *Queue Settings* page, deselect *Enable Cross-Region Failover*.
. If the queue has an associated dead-letter queue, disable failover for that queue.
. Click *Save Changes*.
+
Anypoint MQ disables failover and removes the fallback queue from the queue details pane.
. Restart all applications consuming from or publishing to the queue.


[[primary-fallback-regions]]
== Primary-Fallback Regions

[%header,cols="8,12,12,12,12"]
|===
| Location | Primary Region Name | Primary Region |Fallback Region Name|Fallback Region
5+h| US Control Plane
.4+| North America | US East (N. Virginia)|`us-east-1` | US East (Ohio)|`us-east-2`
                   | US East (Ohio)       |`us-east-2` | US West (Oregon)|`us-west-2`
                   | US West (Oregon)     |`us-west-2`| Canada  (Central)|`ca-central-1`
                   | Canada  (Central)    |`ca-central-1`| US East (N. Virginia)|`us-east-1`
.2+| Europe        | Europe (Ireland)     |`eu-west-1`| Europe (London)|`eu-west-2`
                   | Europe (London)      |`eu-west-2`| Europe (Ireland)|`eu-west-1` 
.3+| APAC          | Asia Pacific (Singapore) |`ap-southeast-1`| Asia Pacific (Tokyo)|`ap-northeast-1`
                   | Asia Pacific (Sydney) |`ap-southeast-2`| Asia Pacific (Singapore)|`ap-southeast-1`
                   | Asia Pacific (Tokyo)  |`ap-northeast-1`| Asia Pacific (Sydney)|`ap-southeast-2`
5+h| EU Control Plane
.2+| Europe        | Europe (Frankfurt)    |`eu-central-1`| Europe (Ireland)|`eu-west-1`
                   | Europe (Ireland)      |`eu-west-1`| Europe (Frankfurt)|`eu-central-1` 
|===

[[perf-and-billing]]
== Performance and Billing Considerations 

The consumer polls the fallback queue for messages once per minute,
which:

* Results in an additional 1440 API requests per day per consumer
* Can cause latency

To change the frequency, configure the `??` attributes in the connector settings.
For information, see:

* xref:anypoint-mq-connector::anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 4.x Reference]
* xref:connectors::anypoint-mq/3.x/anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 3.x Reference]

[[region-unavailability]]
== Region Unavailability

The connector considers a region as unavailable in cases where the Anypoint MQ backend server is:

* Down, resulting in HTTP 5xx (Server Error) status codes to the connector.
* Up, but is slow or unresponsive.
+
For example, the connector receives Timeout errors while making REST API calls to the backend server.
* Available in some situations, but not others.
+
For example:
+
** Unresponsive for queues, but available for other usage, such as message exchanges
** Unavailable for publishing large payloads but available for publishing smaller messages

When the connector receives an HTTP 5xx or Timeout error,
it temporarily marks the region as down for the specific queue and switches to the fallback queue.

The connector periodically (once per minute by default) tries to publish or consume from the primary region to determine if it is available.


== See Also

* xref:anypoint-mq-connector::anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 4.x Reference]
* xref:connectors::anypoint-mq/3.x/anypoint-mq-connector-reference.adoc[Anypoint MQ Connector 3.x Reference]
* xref:mq-queues.adoc[]
* xref:mq-queues.adoc#create-a-queue[Create a Queue]
