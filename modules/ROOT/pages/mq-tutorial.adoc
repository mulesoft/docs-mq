= Tutorial: Create a Queue and Message Exchange
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: mq, tutorial, queue, exchange, message exchange, client, postman

This tutorial helps you send and receive messages using Anypoint MQ using a 
publish/subscribe queue mechanism. Anypoint MQ provides a user interface built into
Anypoint Platform that lets you send messages to a queue or message exchange, 
and then read the messages from a queue. Anypoint MQ also provides a connector 
that works with Anypoint Studio.

== Prerequisites

. Read xref:mq-understanding.adoc[MQ Terminology].
. Create an Anypoint Platform account to configure an environment, user permissions, register applications in MQ, and to create queues and message exchanges. You can access Anypoint MQ in the Anypoint Platform and the left navigation bar.
. An Enterprise license is required to use MQ. Contact the MuleSoft Sales team to get a free trial.
. Download and install Anypoint Studio.
. You need a https://curl.haxx.se[curl command] to test MQ in this tutorial. 

Queue and message exchange names can contain alphanumeric characters (a-z, A-Z, 0-9), dots (.), and dashes (-). All other characters are not allowed. Queue and message exchange names are limited to 127 characters in length.

== Create a Queue

A queue provides a temporary area for holding messages. Applications
push messages to the queue, and other applications consume
the messages. In Anypoint MQ, you can read messages, return the messages
for later viewing, or delete a message. By default, messages return to the
waiting area so that other applications can read them. Messages persist until the
time to live (TTL) value expires. By default, a message persists in Anypoint MQ
for up to 7 days. The minimum message TTL is 1 minute and the maximum is 14 days.

. Log into Anypoint Platform and click MQ.
. Click Destinations:
+
image::mq-destinations-option.png[]
+
. Click the blue plus icon image:mq-blue-plus-icon.png[]
. In the drop-down, click *Queue*:
+
image::mq-create-choices.png[]
+
image::mq-create-q-screen-dlq.png[]
+
. In the Create Queue screen, specify a name for the queue, and if needed, change the
Default TTL (time-to-live) and Default Lock TTL values. A message lock makes a message unavailable to other applications while locked. A locked message does not block other messages to be read.
. If you want your queue encrypted,
slide the encryption slider to the right.
. If your organization previously created a dead letter queue where undeliverable messages go, click *Assign a Dead Letter Queue* to enable this option. For more information on dead letter queues, see xref:mq-queues.adoc#create-a-queue[Create a Queue].
. When done, click *Save Changes*:
+
The queue creates and you are returned to the *Destinations* screen.

*Note*: Where you click on a queue entry in the Destinations screen governs
what you see next:

image::mq-entryui.png[]

*Note:* If you need to delete a queue, see xref:mq-faq.adoc#how-do-i-delete-a-queue[How do I delete a queue?] in the xref:mq-faq.adoc[MQ FAQ].

== Send a Message to a Queue

. Log into Anypoint Platform and click MQ.
. Click Destinations.
. Click the MyDemoQueue entry in Destinations to view details about
the queue.
. Click the left side of the queue entry to open the Messaging feature, or click the right side of the queue entry and click the arrow to the right of the queue name:
+
image::mq-access-messaging2.png[]
+
. In the settings page, click *Message Sender*:
+
image::mq-click-msg-sender2.png[]
+
. Type text in the Payload such as `Hello Mules` (leave the *Type* field set to *Text*):
+
image::mq-msg-sender-text-payload2.png[]
+
. Click *Send*.

== Verify the Message in a Queue

. Click Destinations.
. Click the right side of the queue entry to view details and see the number of messages in the queue:
+
image::mq-num-queued-msgs.png[]

== Get a Message From a Queue

. Follow the directions in <<Send a Message to a Queue>> and
advance to Step 6, except click *Message Browser*:
+
image::mq-click-msg-browser2.png[]
+
. Click Get Messages.
+
image::mq-get-messages2.png[]
+
. Click the message ID value to view the message.
+
image::mq-click-id2.png[]
+
. If you want to return the message to the queue, so other applications can read
the message, click the Return Messages icon - this is the default condition. 
If you switch screens back to the Message Sender or to Destinations, messages 
automatically return to the queue. In Anypoint MQ, returning the messages to the 
queue is known as `nack` - the message is not altered. However, the time to 
live (TTL) value you set when you created your queue determines how long the 
message is available before Anypoint MQ deletes it.
+
image::mq-click-retmsgs2.png[]
+
Alternatively, you can delete the message by clicking the trash can icon. Anypoint MQ provides three modes for how messages delete after they are viewed. For more information, see xref:mq-ack-mode.adoc[Acknowledge a Message].
+
image::mq-message-delete-trash-can-icon2.png[]

Now you are able to send and receive messages in Anypoint MQ. In the next section, you can try
alternate ways of formatting messages.

== Send a CSV or JSON Message

. Click *Message Sender*.
. Set the *Type* to *JSON*.
. Set the *Payload* to:
+
[source,json,linenums]
----
{
"animal that walks":"dog",
"animal that swims":"fish",
"animal that flies":"parrot"
}
----
+
. Click *Message Browser* and the message ID to view the message:
+
image::mq-json-get-msg2.png[]

To send a CSV message:

. Click *Message Sender*.
. Set the *Type* to *CSV*.
. Set the *Payload* to:
+
----
"dog",
"fish",
"parrot"
----
+
. Click Message Browser and the message ID to view the message.

== Register a Client Application

. Log into Anypoint Platform and click MQ.
. Click Client App:
+
image::mq-click-client-apps.png[]
+
. Click the blue plus icon image:mq-blue-plus-icon.png[]
. Specify an application name such as `DemoClientApp` and click Save Changes.
+
image::mq-create-client-app-name.png[]
+
. Leave the Client Apps window open as you need to copy and
paste the Client ID and Client Secret
into the configuration for Anypoint Studio in <<Create an Application>>.

== Configure MQ in Design Center

. Before starting to configure an application in Design Center, open a window to Anypoint 
Platform > MQ and determine which queue you want to access, and have a client application available to get it's client ID and secret from.
. In Anypoint Platform > Design Center, click Create.
. Provide a project name and click Create.
. Select a trigger for the action that starts the MQ connector access. The 
simplest is to use an HTTP Listener, which we use in this tutorial to initiate access using the curl command. Alternatively you can use MQ as a Subscriber to retrieve messages from a destination name, or specify a Scheduler to accept input at prescribed times. 
. In the HTTP Listener, set the Path to the `/mq/{messageId}` value.
. Click the plus symbol to the right of the trigger.
. In the Component menu, select the Mule Anypoint MQ Connector.
. For this tutorial, select the Publish operation. For the other operations, if you were constructing your application to receive a message sent from a queue, you would use the Consume operation. If your application had tests to determine if message processing succeeded, you would use the Ack operation  
to acknowledge that a message was received and could be deleted. Similarly if message 
processing failed, you would use the Nack operation to negatively acknowledge the message. In the case of Nack, the message would be returned to the queue to await accessing. 
. In the Destination, specify the name of queue you want to access.

== Configure Studio for the MQ Connector Plugin

. In Anypoint Studio, click the Exchange icon in the Studio taskbar.
. Click Login in Anypoint Exchange.
. Search for the Anypoint MQ connector and click Install.
. Follow the prompts to install the connector.

See: xref:3.9@mule-runtime::anypoint-mq-connector.adoc[Anypoint MQ Connector]

== Create a Studio 7 Application

XXX

== Create a Studio 6 Application

*Note:* This section applies only to Anypoint Studio 6. For Studio 7, see the earlier section
<<Create a Studio 7 Application>>.

. Create a new Mule Project. Click File > New > Mule Project. Name the project "mqdemo".
. Search for "http" and drag the HTTP Connector to the Studio Canvas.
+
Here's what we want to construct:
+
image::mq-connector-visual-flow.png[]
+
.. Search for "set" and drag *Set Payload* to the Canvas.
.. Search for "mq" and drag the *Anypoint MQ* connector icon to the canvas.
.. Search for "logger" and drag *Logger* to the Canvas.
. Click the HTTP Connector and click the green plus sign to the right of *Connector Configuration*:
. In the HTTP Connector's Global Element Properties accept the defaults, and click OK.
. Set the Path to `/mq/{messageId}`:
+
image::mq-http-path.png[]
+
. Click Set Payload in the Canvas and set the Value to:
+
----
#[message.inboundProperties.'http.uri.params'.messageId]
----
+
image::mq-set-payload.png[]
+
. Click the Anypoint MQ connector, and click the green plus sign to the right of Connector Configuration:
. In the MQ Connector's Global Element Properties window, add the information from Anypoint Platform:
+
image::mq-connector-properties.png[]
+
.. Copy the Anypoint Platform's *Client App* > *Client App ID* value to the Studio *Client ID* field.
+
image::mq-client-id-and-secret-values.png[]
+
.. Copy the Anypoint Platform's *Client App* > *Client Secret* value to the Studio *Client Secret* field.
+
See: xref:3.9@mule-runtime::anypoint-mq-connector.adoc[Anypoint MQ Connector]
+
.. Click *OK*.
. Click the *Operation* field and specify the `publish` operation.
+
image::mq-operation-publish.png[]
+
. Specify the *Destination* as `MyDemoQueue` that you set in Anypoint Platform:
+
image::mq-destination-queue2.png[]
+
. Click the *Logger* and set the Message field to:
+
*MQ Message: #[payload]*
+
image::mq-logger-properties.png[]
+
. Save your project.

== Verify XML

After you configure your application using the MQ Connector, you can check your configuration against this XML.

Click Configuration XML in Studio and compare your XML to the following. If needed, you can make corrections.

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq" 
xmlns:http="http://www.mulesoft.org/schema/mule/http" 
xmlns="http://www.mulesoft.org/schema/mule/core" 
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
	http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core 
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http 
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq 
http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" 
    host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <anypoint-mq:config name="Anypoint_MQ_Configuration" 
    doc:name="Anypoint MQ Configuration">
        <anypoint-mq:provider 
        url="https://mq-us-east-1.anypoint.mulesoft.com/api/v1" 
        clientId="<client_ID_value>" clientSecret="<client_secret-value>"/>
    </anypoint-mq:config>
    <flow name="mqdemoFlow">
        <http:listener config-ref="HTTP_Listener_Configuration" 
        path="/mq/{messageId}" doc:name="HTTP"/>
        <set-payload value="#[message.inboundProperties.'http.uri.params'.messageId]" 
        doc:name="Set Payload"/>
        <anypoint-mq:publish config-ref="Anypoint_MQ_Configuration" 
        doc:name="Anypoint MQ" destination="MyDemoQueue"/>
        <logger message="MQ Message = #[payload]" level="INFO" 
        doc:name="Logger"/>
    </flow>
</mule>
----

== Run the Studio Application

In Anypoint Studio, click the project name in Package Explorer, and click Run > Run As > Mule Application.

The output should end with these statements:

[source,text,linenums]
----
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ Started app 'mqdemo'                                     +
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
INFO  <date_and_time> [main] org.mule.module.launcher.DeploymentDirectoryWatcher:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ Mule is up and kicking (every 5000ms)                    +
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
INFO  <date_and_time> [main] org.mule.module.launcher.StartupSummaryDeploymentListener:
**********************************************************************
*              - - + DOMAIN + - -               * - - + STATUS + - - *
**********************************************************************
* default                                       * DEPLOYED           *
**********************************************************************

*******************************************************************************************
*      - - + APPLICATION + - -      *       - - + DOMAIN + - -       * - - + STATUS + - - *
*******************************************************************************************
* mqdemo                            * default                        * DEPLOYED           *
*******************************************************************************************
----

== Test Your Application

Get a REST plugin for your browser so that you can send POST requests. Typical software:

* https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop[Postman for Chrome]
* https://chrome.google.com/webstore/detail/simple-rest-client/fhjcajmcbmldlhcimfajhfbgofnpcjmb[Simple REST Client for Chrome].
* https://addons.mozilla.org/en-US/firefox/addon/restclient[RESTClient for Firefox].
* http://www.telerik.com/fiddler[Fiddler for Windows].

The following is an example setup using Postman:

image::mq-post.png[]

To set up Postman for a REST POST:

. Specify the URL to send the message as `0.0.0.0:8081/mq/Hello`. You can also specify messages with spaces such as,
`0.0.0.0:8081/mq/My What A Great Message`.
. Click *POST* in the drop-down options menu.
. Click *Send* to post the message. You can send more than one message if you prefer.
. View the resulting reply from the Anypoint Studio web server.

== View Your Message

. Log into Anypoint Platform and click MQ.
. Click Destinations.
. Click `MyDemoQueue` at the right side to view the number of messages in the queue:
+
image::mq-messages-in-queue2.png[]
+
You can see the number of messages in the queue. Having verified that you have messages, we can now view them.
+
. Click `MyDemoQueue` at the start of the entry to view the Queue Settings, Message Sender, and Message Browser.
+
image::mq-view-mydemoq-settings2.png[]
+
. Click *Message Browser* and click *Get Messages*:
+
image::mq-get-messages2.png[]
+
. Click a message ID and view the message to the right.
+
image::mq-click-id-to-see-msg2.png[]

You can repeat this process by returning to your REST POST application and sending and viewing more messages.
In the next section, we build on your knowledge, first with an administrative task of creating user roles and then creating and testing message exchanges, which let you send one message to multiple queues.

[[advancedmq]]
== Create a Message Exchange

A message exchange groups one or more queues so that a message sent to the message exchange goes to all bound queues.

. Log into Anypoint Platform and click MQ.
. Click Destinations.
. Click the blue plus icon image:mq-blue-plus-icon.png[]
. Click Exchange.
. Specify the name `MyDemoExchange`.
. Click the checkbox to bind MyDemoQueue to this message exchange.
. Click Save Changes.
. In the Destinations screen. click the message exchange Type to list its details.

To delete a message exchange, see xref:mq-faq.adoc#how-do-i-delete-an-exchange[How do I delete a Message Exchange?] in the xref:mq-faq.adoc[Anypoint MQ FAQ].

== Bind a Queue to a Message Exchange

. Log into Anypoint Platform and click MQ.
. Click Destinations.
. Click the left side of the message exchange entry in Destinations.
+
*Note*: Where you click on a message exchange entry in the Destinations table governs
what you see next:
+
image::mq-where-to-click-x2.png[]
+
. In the Exchange menu, click Bind for each queue you want to bind to the message exchange:
+
image::mq-bind-queue-to-exchange2.png[]

== Send a Message to a Message Exchange

Sending a message to a message exchange is very similar to sending a message to a queue.
The only difference is that you can get the message from any queue bound to a message exchange.

. Log into Anypoint Platform and click MQ.
. Click Destinations.
. Click the `MessageExchange` entry in Destinations to view details about
the message exchange.
. Click the MessageExchange link in the details screen to access the Message Sender:
+
image::mq-exchange-msg-access2.png[]
+
. Click Message Sender:
+
image::mq-exchange-msg-sender2.png[]
+
. Type the contents of the Payload and click Send:
+
image::mq-exchange-payload2.png[]

You can now use the Message Browser to get the message from the MyDemoQueue as described
in <<Get a Message From a Queue>>.

You can also send comma-separated value (CSV) or JSON content in the payload by changing
the message Type value. For more information, see <<Send a CSV or JSON Message>>.

== See Also

* https://docs.mulesoft.com/mq/[Anypoint MQ]
